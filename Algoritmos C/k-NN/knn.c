#include "tabela.h"
#include "utils.h"

float x_treino[][4] = {
    {5.7, 2.9, 4.2, 1.3}, {7.6, 3.0, 6.6, 2.1}, {5.6, 3.0, 4.5, 1.5},
    {5.1, 3.5, 1.4, 0.2}, {7.7, 2.8, 6.7, 2.0}, {5.8, 2.7, 4.1, 1.0},
    {5.2, 3.4, 1.4, 0.2}, {5.0, 3.5, 1.3, 0.3}, {5.1, 3.8, 1.9, 0.4},
    {5.0, 2.0, 3.5, 1.0}, {6.3, 2.7, 4.9, 1.8}, {4.8, 3.4, 1.9, 0.2},
    {5.0, 3.0, 1.6, 0.2}, {5.1, 3.3, 1.7, 0.5}, {5.6, 2.7, 4.2, 1.3},
    {5.1, 3.4, 1.5, 0.2}, {5.7, 3.0, 4.2, 1.2}, {7.7, 3.8, 6.7, 2.2},
    {4.6, 3.2, 1.4, 0.2}, {6.2, 2.9, 4.3, 1.3}, {5.7, 2.5, 5.0, 2.0},
    {5.5, 4.2, 1.4, 0.2}, {6.0, 3.0, 4.8, 1.8}, {5.8, 2.7, 5.1, 1.9},
    {6.0, 2.2, 4.0, 1.0}, {5.4, 3.0, 4.5, 1.5}, {6.2, 3.4, 5.4, 2.3},
    {5.5, 2.3, 4.0, 1.3}, {5.4, 3.9, 1.7, 0.4}, {5.0, 2.3, 3.3, 1.0},
    {6.4, 2.7, 5.3, 1.9}, {5.0, 3.3, 1.4, 0.2}, {5.0, 3.2, 1.2, 0.2},
    {5.5, 2.4, 3.8, 1.1}, {6.7, 3.0, 5.0, 1.7}, {4.9, 3.1, 1.5, 0.1},
    {5.8, 2.8, 5.1, 2.4}, {5.0, 3.4, 1.5, 0.2}, {5.0, 3.5, 1.6, 0.6},
    {5.9, 3.2, 4.8, 1.8}, {5.1, 2.5, 3.0, 1.1}, {6.9, 3.2, 5.7, 2.3},
    {6.0, 2.7, 5.1, 1.6}, {6.1, 2.6, 5.6, 1.4}, {7.7, 3.0, 6.1, 2.3},
    {5.5, 2.5, 4.0, 1.3}, {4.4, 2.9, 1.4, 0.2}, {4.3, 3.0, 1.1, 0.1},
    {6.0, 2.2, 5.0, 1.5}, {7.2, 3.2, 6.0, 1.8}, {4.6, 3.1, 1.5, 0.2},
    {5.1, 3.5, 1.4, 0.3}, {4.4, 3.0, 1.3, 0.2}, {6.3, 2.5, 4.9, 1.5},
    {6.3, 3.4, 5.6, 2.4}, {4.6, 3.4, 1.4, 0.3}, {6.8, 3.0, 5.5, 2.1},
    {6.3, 3.3, 6.0, 2.5}, {4.7, 3.2, 1.3, 0.2}, {6.1, 2.9, 4.7, 1.4},
    {6.5, 2.8, 4.6, 1.5}, {6.2, 2.8, 4.8, 1.8}, {7.0, 3.2, 4.7, 1.4},
    {6.4, 3.2, 5.3, 2.3}, {5.1, 3.8, 1.6, 0.2}, {6.9, 3.1, 5.4, 2.1},
    {5.9, 3.0, 4.2, 1.5}, {6.5, 3.0, 5.2, 2.0}, {5.7, 2.6, 3.5, 1.0},
    {5.2, 2.7, 3.9, 1.4}, {6.1, 3.0, 4.6, 1.4}, {4.5, 2.3, 1.3, 0.3},
    {6.6, 2.9, 4.6, 1.3}, {5.5, 2.6, 4.4, 1.2}, {5.3, 3.7, 1.5, 0.2},
    {5.6, 3.0, 4.1, 1.3}, {7.3, 2.9, 6.3, 1.8}, {6.7, 3.3, 5.7, 2.1},
    {5.1, 3.7, 1.5, 0.4}, {4.9, 2.4, 3.3, 1.0}, {6.7, 3.3, 5.7, 2.5},
    {7.2, 3.0, 5.8, 1.6}, {4.9, 3.1, 1.5, 0.1}, {6.7, 3.1, 5.6, 2.4},
    {4.9, 3.0, 1.4, 0.2}, {6.9, 3.1, 4.9, 1.5}, {7.4, 2.8, 6.1, 1.9},
    {6.3, 2.9, 5.6, 1.8}, {5.7, 2.8, 4.1, 1.3}, {6.5, 3.0, 5.5, 1.8},
    {6.3, 2.3, 4.4, 1.3}, {6.4, 2.9, 4.3, 1.3}, {5.6, 2.8, 4.9, 2.0},
    {5.9, 3.0, 5.1, 1.8}, {5.4, 3.4, 1.7, 0.2}, {6.1, 2.8, 4.0, 1.3},
    {4.9, 2.5, 4.5, 1.7}, {5.8, 4.0, 1.2, 0.2}, {5.8, 2.6, 4.0, 1.2},
    {7.1, 3.0, 5.9, 2.1}};
float x_teste[][4] = {
    {6.1, 2.8, 4.7, 1.2}, {5.7, 3.8, 1.7, 0.3}, {7.7, 2.6, 6.9, 2.3},
    {6.0, 2.9, 4.5, 1.5}, {6.8, 2.8, 4.8, 1.4}, {5.4, 3.4, 1.5, 0.4},
    {5.6, 2.9, 3.6, 1.3}, {6.9, 3.1, 5.1, 2.3}, {6.2, 2.2, 4.5, 1.5},
    {5.8, 2.7, 3.9, 1.2}, {6.5, 3.2, 5.1, 2.0}, {4.8, 3.0, 1.4, 0.1},
    {5.5, 3.5, 1.3, 0.2}, {4.9, 3.1, 1.5, 0.1}, {5.1, 3.8, 1.5, 0.3},
    {6.3, 3.3, 4.7, 1.6}, {6.5, 3.0, 5.8, 2.2}, {5.6, 2.5, 3.9, 1.1},
    {5.7, 2.8, 4.5, 1.3}, {6.4, 2.8, 5.6, 2.2}, {4.7, 3.2, 1.6, 0.2},
    {6.1, 3.0, 4.9, 1.8}, {5.0, 3.4, 1.6, 0.4}, {6.4, 2.8, 5.6, 2.1},
    {7.9, 3.8, 6.4, 2.0}, {6.7, 3.0, 5.2, 2.3}, {6.7, 2.5, 5.8, 1.8},
    {6.8, 3.2, 5.9, 2.3}, {4.8, 3.0, 1.4, 0.3}, {4.8, 3.1, 1.6, 0.2},
    {4.6, 3.6, 1.0, 0.2}, {5.7, 4.4, 1.5, 0.4}, {6.7, 3.1, 4.4, 1.4},
    {4.8, 3.4, 1.6, 0.2}, {4.4, 3.2, 1.3, 0.2}, {6.3, 2.5, 5.0, 1.9},
    {6.4, 3.2, 4.5, 1.5}, {5.2, 3.5, 1.5, 0.2}, {5.0, 3.6, 1.4, 0.2},
    {5.2, 4.1, 1.5, 0.1}, {5.8, 2.7, 5.1, 1.9}, {6.0, 3.4, 4.5, 1.6},
    {6.7, 3.1, 4.7, 1.5}, {5.4, 3.9, 1.3, 0.4}, {5.4, 3.7, 1.5, 0.2},
    {5.5, 2.4, 3.7, 1.0}, {6.3, 2.8, 5.1, 1.5}, {6.4, 3.1, 5.5, 1.8},
    {6.6, 3.0, 4.4, 1.4}, {7.2, 3.6, 6.1, 2.5},
};

int y_teste[][3] = {
    {0, 0, 1}, {1, 0, 0}, {0, 1, 0}, {0, 0, 1}, {0, 0, 1}, {1, 0, 0}, {0, 0, 1},
    {0, 1, 0}, {0, 0, 1}, {0, 0, 1}, {0, 1, 0}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 0}, {0, 0, 1}, {0, 1, 0}, {0, 0, 1}, {0, 0, 1}, {0, 1, 0}, {1, 0, 0},
    {0, 1, 0}, {1, 0, 0}, {0, 1, 0}, {0, 1, 0}, {0, 1, 0}, {0, 1, 0}, {0, 1, 0},
    {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, {0, 0, 1}, {1, 0, 0}, {1, 0, 0},
    {0, 1, 0}, {0, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, {0, 1, 0}, {0, 0, 1},
    {0, 0, 1}, {1, 0, 0}, {1, 0, 0}, {0, 0, 1}, {0, 1, 0}, {0, 1, 0}, {0, 0, 1},
    {0, 1, 0}};

int y_treino[][3] = {
    {0, 0, 1}, {0, 1, 0}, {0, 0, 1}, {1, 0, 0}, {0, 1, 0}, {0, 0, 1}, {1, 0, 0},
    {1, 0, 0}, {1, 0, 0}, {0, 0, 1}, {0, 1, 0}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {0, 0, 1}, {1, 0, 0}, {0, 0, 1}, {0, 1, 0}, {1, 0, 0}, {0, 0, 1}, {0, 1, 0},
    {1, 0, 0}, {0, 1, 0}, {0, 1, 0}, {0, 0, 1}, {0, 0, 1}, {0, 1, 0}, {0, 0, 1},
    {1, 0, 0}, {0, 0, 1}, {0, 1, 0}, {1, 0, 0}, {1, 0, 0}, {0, 0, 1}, {0, 0, 1},
    {1, 0, 0}, {0, 1, 0}, {1, 0, 0}, {1, 0, 0}, {0, 0, 1}, {0, 0, 1}, {0, 1, 0},
    {0, 0, 1}, {0, 1, 0}, {0, 1, 0}, {0, 0, 1}, {1, 0, 0}, {1, 0, 0}, {0, 1, 0},
    {0, 1, 0}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, {0, 0, 1}, {0, 1, 0}, {1, 0, 0},
    {0, 1, 0}, {0, 1, 0}, {1, 0, 0}, {0, 0, 1}, {0, 0, 1}, {0, 1, 0}, {0, 0, 1},
    {0, 1, 0}, {1, 0, 0}, {0, 1, 0}, {0, 0, 1}, {0, 1, 0}, {0, 0, 1}, {0, 0, 1},
    {0, 0, 1}, {1, 0, 0}, {0, 0, 1}, {0, 0, 1}, {1, 0, 0}, {0, 0, 1}, {0, 1, 0},
    {0, 1, 0}, {1, 0, 0}, {0, 0, 1}, {0, 1, 0}, {0, 1, 0}, {1, 0, 0}, {0, 1, 0},
    {1, 0, 0}, {0, 0, 1}, {0, 1, 0}, {0, 1, 0}, {0, 0, 1}, {0, 1, 0}, {0, 0, 1},
    {0, 0, 1}, {0, 1, 0}, {0, 1, 0}, {1, 0, 0}, {0, 0, 1}, {0, 1, 0}, {1, 0, 0},
    {0, 0, 1}, {0, 1, 0}

};

int main(int argc, char* argv[]) {
    int k;
    switch (argc) {
    case 1:
        k = 5;
        break;
    case 2:
        k = atoi(argv[1]);
        break;
    default:
        printf("Você deve fornecer 1 argumento mas forneceu %d\n", argc - 1);
        exit(1);
        break;
    }
    if (k == 0) {
        printf("Você deve fornecer como argumento um número inteiro entre 1 e "
               "100\n");
        exit(1);
    }

    Tabela_v_4_f X_treino = tabela_v_4_f(100);
    for (int i = 0; i < 100; i++) {

        X_treino = tabela_v_4_f_ad(
            X_treino, linha_v_4_f(x_treino[i][0], x_treino[i][1],
                                  x_treino[i][2], x_treino[i][3], i));
    }

    Tabela_v_3_f Y_treino = tabela_v_3_f(100);
    for (int i = 0; i < 100; i++) {
        Y_treino = tabela_v_3_f_ad(
            Y_treino,
            linha_v_3_f(y_treino[i][0], y_treino[i][1], y_treino[i][2], i));
    }

    Tabela_v_4_f X_teste = tabela_v_4_f(50);
    for (int i = 0; i < 50; i++) {
        X_teste = tabela_v_4_f_ad(X_teste,
                                  linha_v_4_f(x_teste[i][0], x_teste[i][1],
                                              x_teste[i][2], x_teste[i][3], i));
    }

    Tabela_v_3_f Y_teste = tabela_v_3_f(50);
    for (int i = 0; i < 50; i++) {
        Y_teste =
            tabela_v_3_f_ad(Y_teste, linha_v_3_f(y_teste[i][0], y_teste[i][1],
                                                 y_teste[i][2], i));
    }

    printf("X_treino:\n");
    print_tabela_v_4_f(X_treino);
    printf("\nX_teste:\n");
    print_tabela_v_4_f(X_teste);
    printf("\nY_treino:\n");
    print_tabela_v_3_f(Y_treino);
    printf("\nY_teste:\n");
    print_tabela_v_3_f(Y_teste);
    float acertos = 0;

    for (int i = 0; i < 50; i++) {
        V4f analisando = X_teste.linhas[i].v;
        Tabela_v_1_f distancias = distancia_v_t(analisando, X_treino);
        int* indices = malloc(k * sizeof(int));
        n_menores(k, indices, distancias);
        V3f escolhas = v3f(0, 0, 0);

        // Adicionar 1 no indice em cada manor distância
        for (int j = 0; j < k; j++) {
            escolhas = v_3_f_ad(escolhas, Y_treino.linhas[indices[j]].v);
        }
        printf("Saída real: (%d, %d, %d). Saidas mais proximas: (%.0f, %.0f, "
               "%.0f)\n",
               y_teste[i][0], y_teste[i][1], y_teste[i][2], escolhas.x1,
               escolhas.x2, escolhas.x3);

        // Ver se as acertou
        int escolha = v_3_f_maior(escolhas);
        if (y_teste[i][escolha] == 1) {
            acertos++;
        }
    }

    printf("\nAcertos: %.0f/50 = %.2f%%\n", acertos, 100 * acertos / 50);

    return 0;
}
